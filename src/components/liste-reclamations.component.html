<div class="container">
  <!-- HERO -->
<div class="hero">
  <div class="hero__left">
    <h1>Liste des réclamations</h1>
    <p class="hero__subtitle">Suivez et traitez les demandes en un coup d’œil</p>
  </div>

  <div class="hero__actions">
    <button mat-stroked-button class="btn-ghost" (click)="refresh()">
      <mat-icon class="i-rotate">autorenew</mat-icon>
      Actualiser
    </button>
     <button
    *ngIf="!isAgent"
    type="button"
    class="btn btn--primary"
    [routerLink]="['/client/reclamations/nouvelle']">
    <span class="i">＋</span> Nouvelle réclamation
  </button>
  </div>
</div>

<!-- KPI CARDS -->
<section *ngIf="!loading && !error" class="stat-cards">
  <div class="stat">
    <div class="stat__icon stat--total"><mat-icon>inbox</mat-icon></div>
    <div class="stat__info">
      <div class="stat__value">{{ reclamations.length }}</div>
      <div class="stat__label">Total</div>
    </div>
  </div>

  <div class="stat">
    <div class="stat__icon stat--new"><mat-icon>fiber_new</mat-icon></div>
    <div class="stat__info">
      <div class="stat__value">{{ countBy('NOUVELLE') }}</div>
      <div class="stat__label">Nouvelles</div>
    </div>
  </div>

  <div class="stat">
    <div class="stat__icon stat--progress"><mat-icon>hourglass_top</mat-icon></div>
    <div class="stat__info">
      <div class="stat__value">{{ countBy('EN_COURS') }}</div>
      <div class="stat__label">En cours</div>
    </div>
  </div>

  <div class="stat">
    <div class="stat__icon stat--done"><mat-icon>task_alt</mat-icon></div>
    <div class="stat__info">
      <div class="stat__value">{{ countBy('RESOLUE') }}</div>
      <div class="stat__label">Résolues</div>
    </div>
  </div>
</section>


  <!-- Loading / Error / Empty -->
  <div *ngIf="loading" class="loading"><mat-icon class="spinner">autorenew</mat-icon><p>Chargement…</p></div>
  <div *ngIf="!loading && error" class="alert alert-error">{{ error }}</div>
  <div *ngIf="!loading && !error && !reclamations.length" class="empty-state">
    <mat-icon>inbox</mat-icon><h3>Aucune réclamation</h3>
    <button mat-raised-button color="primary" (click)="goNew()">Nouvelle réclamation</button>
  </div>

  <!-- TABLE -->
  <div *ngIf="!loading && !error && reclamations.length" class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th class="th-idx">#</th>
          <th class="th-objet">Objet</th>
          <th class="th-cat t-center">Catégorie</th>
          <th class="th-statut t-center">Statut</th>
          <th class="th-date">Créée</th>
          <th class="th-client hide-sm">Client</th>
          <th class="th-details t-center">Détails</th>
          <th class="th-reponses t-center">Réponses</th>
          <th *ngIf="isAgent" class="th-actions t-right">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let r of reclamations; trackBy: trackById">
          <td class="td-idx">{{ r.id }}</td>

          <td class="td-objet">
            <div class="ellipsis" [title]="r.objet">{{ r.objet }}</div>
          </td>

          <td class="t-center">
            <span class="chip chip--category">{{ r.categorie }}</span>
          </td>

          <td class="t-center">
            <span class="chip" [ngClass]="statusChip(r.statut)">
              {{ labelStatut(r.statut) }}
            </span>
          </td>

          <td class="td-date">
            <span [title]="r.dateCreation | date:'dd/MM/yyyy HH:mm'">
              {{ r.dateCreation | date:'dd/MM/yyyy, HH:mm' }}
            </span>
          </td>

          <td class="hide-sm">
            <div class="ellipsis" [title]="r.clientNom || ('ID ' + r.clientId)">
              {{ r.clientNom || ('ID ' + r.clientId) }}
            </div>
          </td>

          <!-- Détails (colonne séparée) -->
<td class="t-center">
  <button
    mat-icon-button
    aria-label="Voir le détail"
    matTooltip="Détails"
    (click)="goDetails(r)"
  >
    <mat-icon>search</mat-icon>
  </button>
</td>

          <!-- Réponses (colonne séparée) -->
          <td class="t-center">
            <button mat-button color="primary" class="btn-link" (click)="goReponses(r)">Réponses</button>
          </td>

          <!-- Actions statut (agent) -->
          <td *ngIf="isAgent" class="t-right">
            <div class="actions">
              <button mat-stroked-button class="btn-slim"
                      (click)="setNouvelle(r)" [disabled]="patching[r.id] || r.statut==='NOUVELLE'">Nouvelle</button>
              <button mat-stroked-button class="btn-slim"
                      (click)="setEnCours(r)" [disabled]="patching[r.id] || r.statut==='EN_COURS'">En cours</button>
              <button mat-stroked-button class="btn-slim" color="primary"
                      (click)="setResolue(r)" [disabled]="patching[r.id] || r.statut==='RESOLUE'">Résolue</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
